/* jshint browser: true, jquery: true, camelcase: true, indent: 2, undef: true, quotmark: single, maxlen: 80, trailing: true, curly: true, eqeqeq: true, forin: true, immed: true, latedef: true, newcap: true, nonew: true, unused: true, strict: true */

//client side javascript
 /* CPSC 473 Project 1: Filmder (Should I watch this?)
  Submitted by- Team- Oscillatory Memorization
  Email- supra.chavan@gmail.com
 */

/**
 * Sign up functionality for first time user
 * Submits sign up form data to server as JSON
 * Input- Username, Email address, password
 * Output- on success, returns JSON message that user is added successfully.
 */
var callSignUpFunction = function(){
  'use strict';
  var uname = document.getElementsByName('uname')[0].value;
  var email = document.getElementsByName('email')[0].value;
  var pwd1 = document.getElementsByName('pwd1')[0].value;
  var jsonStr = JSON.stringify({'username': uname,
                                'email': email,
                                'password': pwd1});
  $.ajax({
    type: 'POST',
    data: jsonStr,
    dataType: 'json',
    contentType: 'application/json',
    url: 'http://localhost:3000/signup',            
    success: function(data) {
                            console.log('success');
                            console.log(jsonStr);
                            console.log(JSON.stringify(data));
                            console.log(data);
                            $('.result').html(data);
                            $('.signup_form').trigger('reset');
                            $('login_modal').modal('destroy');
    } //end success
  }); //end ajax
}; //end function

/**
 * Log in functionality for registered user
 * Submits login form data to server as JSON
 * Input- Username, password
 * Output- on success, diplays user profile, 
 * returns user id generated by MongoDB
 */
var callLogInFunction = function(){
  'use strict';
  var ulname = document.getElementsByName('ulname')[0].value;
  var pwd = document.getElementsByName('pwd')[0].value;
  var jsonStr = JSON.stringify({'username1': ulname, 'password1': pwd});

  $.ajax({
        type: 'POST',
        data: jsonStr,
        dataType: 'json',
        contentType: 'application/json',
        url: 'http://localhost:3000/login',            
        success: function(data) {
                                console.log('success');
                                console.log(jsonStr);
                                console.log(JSON.stringify(data));
                                console.log(data);

                                if(data.error){
                                  $('.result2').html(data.error);
                                  $('.login_form').trigger('reset');
                                }
                                else{  //successful log in
                                  $('.result2').html(data);
                                  $('.login_form').trigger('reset');
                                  $('.login_modal').modal('hide');

                                  $('.right_menu1').hide();
                                  $('.pointing.label').text(
                                    'Welcome '+data.username);

                                  $('.userId').text(data.userid);
                                  console.log(data.userid);
                                  $('.userId').hide();

                                  $('.right_menu2').show();
                                  $('.login_seg').show();
                                  $('.main_seg').hide();
                                  $('.movie_seg').hide();
                                } //end else
        } //end success
      }); //end ajax
}; //end function

/**
 * Add movies functionality for logged in user
 * Submits  add movies form data to server as JSON
 * Input- Moviename, user id
 * Output- on success, returns JSON message that movie is added successfully.
 */
var callAddMoviesFunction = function() {
  'use strict';
  
  var movieName = document.getElementsByName('moviename')[0].value;
  var userID = $('span.userId').text();
  console.log(userID);
  var jsonStr = JSON.stringify({'movieName': movieName, 
                                'userId': userID});
  $.ajax({
          type: 'POST',
          data: jsonStr,
          dataType: 'json',
          contentType: 'application/json',
          url: 'http://localhost:3000/addmovies',            
          success: function(data) {
                                  $('.result3').html(data);
                                  $('.addmovie_form').trigger('reset');
                                  $('.result3').html();
          } //end success
  }); //end ajax
}; //end function

/**
 * Delete movies functionality for logged in user
 * Submits delete movie form data to server as JSON
 * Input- Movie name, user id
 * Output- on success, returns JSON message that movie is deleted successfully 
 * from user's list
 */
var callDeleteMoviesFunction = function(){
  'use strict';
  var movieName = document.getElementsByName('dmoviename')[0].value;
  var userID = $('span.userId').text();
  console.log(userID);
  var jsonStr = JSON.stringify({'movieName': movieName, 'userId': userID});
  console.log(jsonStr);
  $.ajax({
          type: 'POST',
          data: jsonStr,
          dataType: 'json',
          contentType: 'application/json',
          url: 'http://localhost:3000/deletemovie',            
          success: function(data) {
                                $('.result4').html(data);
                                $('.deletemovie_form').trigger('reset');
                                $('.result4').html();
          } //end success
  }); //end ajax
}; //end function

/**
 * Functionality to handle "watch it" or "skip it" button clicks
 * Input- name of the movie
 * passed as an argument nameMovie
 * Output- calls function Voting() with argument nameMovie 
 */
var VoteButton = function(nameMovie){
  'use strict';
  $('#VoteUp').click(function () {
    $('#VoteResult').empty();
    $('#VoteResult2').empty();
    Voting(nameMovie,1); 
  });
  
  $('#VoteDown').click(function () {
    $('#VoteResult').empty();
    $('#VoteResult2').empty();
    Voting(nameMovie,-1);  
  });

  $('.nextButton').click(function(){
    callShow1MovieFunction();
  });
  
  $('#NeverSeen').click(function(){
    callShow1MovieFunction();
  });

};

/**
 * Functionality add "next movie" button to index.html
 * Input- -
 * Output- calls function Voting()
 */
var Nexting = function(){
  'use strict';
  $('#VoteResult').append(
    '<br><div class="nextButton ui buttom aligned fluid inverted button">'+
    'NEXT MOVIE</div>');
  $('#VoteResult2').append(
    '<br><div class="nextButton ui buttom aligned fluid inverted button">'+
    'NEXT MOVIE</div>');
  VoteButton();
};

/**
 * Functionality to post upvote or downvote score on
 * "watch it" or "skip it" button clicks
 * Input- name of the movie, score
 * Output- updated upvote or downvote score
 */
var Voting = function(nameMovie,score){
  'use strict';
  var result; 
  var jsonStr = JSON.stringify({'movieName': nameMovie, 'score': score});
  $.ajax({  
          type: 'POST',
          data: jsonStr,
          dataType: 'json',
          contentType: 'application/json',
          url: 'http://localhost:3000/scoreUpdate',            
          success: function(data) {
          result = data;
          console.log(result);
          $('#VoteResult2').append(
            '<div><h3>Result</h3><i class="huge thumbs green up icon">' +
            '</i><h3>' + result.upVote + '</h3><br><br>');
          $('#VoteResult').append(
            '<div><h3>Result</h3><i class="huge thumbs red down icon">' +
            '</i><h3>' + result.downVote + '</h3><br><br>');
          Nexting();
      }, //end success
      error: function(){
        console.log('Cannot Vote');
      } //end error
  }); //end ajax
}; //end function Voting()

/**
 * Functionality to add movies and display on index.html
 * Input- data returned on success of ajax call in CallShow1MovieFunction
 * passed as an argument movieObject
 * Output- movie content (e.g. title, poster, etc added to html page)
 * calls function VoteButton() with obtained movie name as an argument
 */
var AddMovieToHtml= function(movieObject){
  'use strict';

  $('#movieCard').empty();  //Semantic UI card to show movie content
  $('#ShowTitle').empty();  

  $('#movieCard').append(
    '<div class="ui three column middle aligned very relaxed stackable grid">' +
    '<div class="middle aligned center black column">' +
    '<div id="VoteResult2"><div class="ui buttons">' + 
    '<div id="VoteUp" class="ui huge huge aligned fluid positive button">'+
    '<i class="large thumbs up icon"></i>Watch It</div>'+
    '</div></div>'+
    '</div><div class="ui vertical divider"></div>' +
    '<div class="middle aligned center black column">' +
    '<img class="ui middle aligned center medium rounded image" src=' + 
    movieObject.mPosterUrl + '>' +
    '</div><div class="ui vertical divider"></div>' +
    '<div class="middle aligned center black column">' +
    '<div id="VoteResult">' +
    '<div class="ui buttons">' + 
          '<div id="VoteDown" class="ui huge aligned fluid negative button" >'+
          '<i class="large thumbs down icon"></i>Skip it</div>'+
    '</div>' +
    '<div class="ui buttons">' + 
    '<div id="NeverSeen" class="ui huge aligned fluid violet button">'+
     'Haven\'t Seen<i class="large right arrow icon"></i></div>'+
    '</div>' +
    '</div>'+
    '</div></div></div>');
  $('#ShowTitle').append(
    '<div class="middle aligned center large black "><h1>'+ 
    movieObject.mTitle + '</h1>('+ movieObject.mYear +')</div><br>');
  VoteButton(movieObject.movieName);
}; //end function

/**
 * Displays 1 movie to vote for, at random on the home page
 * Input- None
 * Output- on success, returns movie information as data  
 * and calls AddMovieToHtml() function with that data as argument
 */
var callShow1MovieFunction =function () {
  'use strict';
  console.log('in ajax get');
  $.ajax({
          type: 'GET',
          dataType: 'json',
          contentType: 'application/json',
          url: 'http://localhost:3000/ShowMovie',            
          success: function(data) {
                          console.log('success');
                          console.log(JSON.stringify(data));
                          console.log(data);
                          AddMovieToHtml(data);
          } //end success
  }); //end ajax
}; //end function

var flag =false;  //Flag to check whether user is logged in or not

/**
 * Functionto check whether user is logged in or not
 * Output- calls function Voting() eith argument nameMovie 
 */
var checkLogin = function(){
  'use strict';
  var spanContent = $('.userId').text();
  console.log('spanContent'+spanContent);
  console.log('flag:'+flag);
  if(spanContent){
    if(flag === true){
      console.log('in function true');
      $('.login_seg').hide();
      $('.right_menu1').hide();       
      $('.right_menu2').show();
      $('.main_seg').show();
      $('.right_menu3').show();  
    }
    else{
      console.log('in function false');
      $('.right_menu2').show();  
      $('.login_seg').show();    
      $('.right_menu1').hide();   
      $('.main_seg').hide();   
      $('.right_menu3').hide();    
    }
  }
  else{
      console.log('in else');
      $('.right_menu1').show();
      $('.main_seg').show();
      $('.right_menu2').hide();
      $('.login_seg').hide();
      $('.right_menu3').hide(); 
  }
};

/**
 * Displays all movies in user's list, for logged in user
 * Input- user id in JSON format as argument jsonStr
 * Output- on success, returns movie information as data 
 * with upvotes and downvotes  
 */
var callShowMoviesFor1User = function(jsonStr){
 'use strict';
  $('.movie_seg').empty();
  $.ajax({
          type: 'POST',
          data: jsonStr,
          dataType: 'json',
          contentType: 'application/json',
          url: 'http://localhost:3000/showMoviesFor1User',            
          success: function(data) {
                                  console.log('success');
                                  console.log(jsonStr);
                                  console.log(JSON.stringify(data));
                                  console.log(data);
                                  if(data.error){
                                    console.log('error');
                                  }
                                  else{
                                    console.log(data.movieList.length);
                                    if(true){
                                      for(var i=0;i < data.movieList.length;i++)
                                        {
                                          $('.movie_seg').append(
                                            '<div ' +
                                            'class="ui grey inverted segment">'+
                                            '<div class="ui grid">' + 
                                            '<div class="eight wide column">' +
                                            '<h3>' + 
                                            data.movieList[i].movieName +
                                            '</h3></div>' + 
                                            '<div ' +
                                            'class="eight wide column">'+
                                            '<div ' +
                                            'class="ui right floated span">' +
                                            '<h3>' +
                                            '<i class="thumbs green up icon">' +
                                            '</i>'+
                                            data.movieList[i].mUpVote +
                                            '  |  <i class' +
                                            '="thumbs red down icon">' +
                                            '</i>'+
                                            data.movieList[i].mDownVote +
                                            '</h3></div></div></div>');  
                                      } //end for
                                    }//end if
                                  }//end else
          } //end success
  }); //end ajax
}; //end function

/**
 * Main function which will be called first 
 */
var main = function(){
  'use strict';
  callShow1MovieFunction();

  $('.watch').click(function(){
    console.log('watch button clicked');
  });

  $('.login_seg').hide();

  checkLogin();

  $('.logout').click(function(){

    $('.right_menu2').hide();
    $('.right_menu1').show();
    $('.login_seg').hide();
    $('.main_seg').show();
    $('span.userId').empty();
    $('.right_menu3').hide();

  });

  $('.signup').click(function () {
    $('.result').empty();
    $('.signup_modal').modal('show');
  });

  $('.login').click(function () {
    $('.result2').empty();
    $('.login_modal').modal('show');
  });

  $('.addmovie_button').click(function () {
    $('.result3').empty();
    $('.addmovie_modal').modal('show');
  });

  $('.showmovie_button').click(function () {
    var userID = $('span.userId').text();
    var jsonStr = JSON.stringify({'userID': userID});
    callShowMoviesFor1User(jsonStr);
    $('.movie_seg').show();
  });

  $('.deletemovie_button').click(function(){
    $('.result4').empty();
    $('.deletemovie_modal').modal('show');
  });

  $('.redirect').click(function(){
    flag = true;  //home page clicked and user logged in
    checkLogin();
  });

  $('.profile').click(function(){
    $('.right_menu1').hide();
    $('.right_menu2').show();
    $('.main_seg').hide();
    $('.login_seg').show();
    $('.right_menu3').hide();
  });

  $('.login').on('click', function(){
    $('signup_modal').modal('hide');
    $('login_modal').modal('show');
  });

  $('.signup').on('click', function(){
    $('signup_modal').modal('show');
    $('login_modal').modal('hide');
  });

  $('.login_form').form({
    fields: {
      ulname: {
        identifier : 'ulname',
        rules: [
          {
            type   : 'empty',
            prompt : 'Please enter a username'
          }
        ]
      },
      pwd: {
            identifier : 'pwd',
            rules: [
              {
                type   : 'empty',
                prompt : 'Please enter a password'
              }
            ]
          },
    },  //end fields
    onSuccess: function(event) {
      callLogInFunction();
      event.preventDefault();
      console.log('form valid');
      $('.result3').empty();
    } //end onSuccess
  }); //end login form validation

  $('.signup_form').form({ 
    fields: {
            username: {
              identifier : 'uname',
              rules: [
                {
                  type   : 'empty',
                  prompt : 'Please enter a username'
                }
              ]
            },
          email: {
            identifier : 'email',
            rules: [
                    {
                      type   : 'email',
                      prompt : 'Please enter a valid email address'
                    },
            ]
          },
          pwd1: {
            identifier : 'pwd1',
            rules: [
                    {
                      type   : 'empty',
                      prompt : 'Please enter a password'
                    },
                    {
                      type   : 'length['+6+']',
                      prompt : 'Your password must be at least 6 characters'
                    }
            ]
          },
          pwd2: {
            identifier : 'pwd2',
            rules: [
                    {
                      type   : 'empty',
                      prompt : 'Please enter a password'
                    },
                    {
                      type   : 'length['+6+']',
                      prompt : 'Your password must be at least 6 characters'
                    },
                    {
                      type   : 'match[pwd1]',
                      prompt : 'Passwords do not match'
                    }
            ]
          },
          terms: {
            identifier : 'chck',
            rules: [
              {
                type   : 'checked',
                prompt : 'You must agree to the terms and conditions'
              }
            ]
          }
    }, //end fields
    onSuccess: function(event) {
      callSignUpFunction();
      event.preventDefault();
      console.log('form valid');  
    } //end onSuccess
  }); //end signup form validation

  $('.addmovie_form').form({
    // $('.result3').html();
    fields: {
      moviename: {
          identifier : 'moviename',
          rules: [
                  {
                    type   : 'empty',
                    prompt : 'This field cannot be empty'
                  }
          ]
      }
    }, //end fields  
    onSuccess: function(event) {
      callAddMoviesFunction();
      event.preventDefault();
      console.log('form valid');
     
    } //end onSuccess
  }); //end add movie form validation

  $('.deletemovie_form').form({
    fields: {
      dmoviename: {
          identifier : 'dmoviename',
          rules: [
            {
              type   : 'empty',
              prompt : 'This field cannot be empty'
            }
            ]
        }
    }, //end fields  
    onSuccess: function(event) {
      callDeleteMoviesFunction();
      event.preventDefault();
      console.log('form valid');
    } //end onSuccess
  }); //end delete movie form validation
}; //end function main

$(document).ready(main);




